<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cinnamoroll Man</title>
    <link rel="stylesheet" href="style.css">
    <style>
        #gameContainerPacman {
            background-color: #000;
            border-radius: 15px;
            padding: 10px;
            user-select: none;
            -webkit-user-select: none;
        }
        #pacmanInstructions {
            font-size: 1.1em;
            margin-bottom: 15px;
        }
        #pacmanResult {
            display: none;
            margin-top: 20px;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>Game Kedua: Cinnamoroll-Man!</h1>
    <p>Gunakan tombol panah atau W/A/S/D untuk bergerak.</p>
    <p id="pacmanInstructions">Hayoo dikejarr desuuuuh</p>
    <div id="gameContainerPacman">
        <canvas id="pacmanCanvas"></canvas>
    </div>
    <div id="pacmanResult">
        <h2 id="resultTitle"></h2>
        <p id="resultMessage"></p>
        <button id="nextButton">Lanjut</button>
    </div>
</div>


<script>
    const canvas = document.getElementById('pacmanCanvas');
    const ctx = canvas.getContext('2d');

    const tileSize = 32;
    canvas.width = 15 * tileSize;
    canvas.height = 16 * tileSize;

    // Aset Gambar
    const playerImg = new Image();
    playerImg.src = 'cinnamoroll_player.png';

    const ghost1Img = new Image();
    ghost1Img.src = 'ciw_ghost.png';

    const ghost2Img = new Image();
    ghost2Img.src = 'kei_ghost.png';

    // Peta Game (0=kosong, 1=dinding, 2=koin)
    const map = [
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,2,2,2,2,2,2,1,2,2,2,2,2,2,1],
        [1,2,1,2,1,1,2,1,2,1,1,2,1,2,1],
        [1,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
        [1,2,1,1,2,1,1,1,1,1,2,1,1,2,1],
        [1,2,2,2,2,2,2,1,2,2,2,2,2,2,1],
        [1,1,1,2,1,1,0,0,0,1,1,2,1,1,1],
        [0,0,1,2,1,0,0,0,0,0,1,2,1,0,0],
        [1,1,1,2,1,0,0,0,0,0,1,2,1,1,1],
        [1,2,2,2,2,2,2,1,2,2,2,2,2,2,1],
        [1,2,1,2,1,1,2,1,2,1,1,2,1,2,1],
        [1,2,2,2,1,1,2,2,2,1,1,2,2,2,1],
        [1,2,1,2,2,2,2,1,2,2,2,2,1,2,1],
        [1,2,1,1,1,1,2,1,2,1,1,1,1,2,1],
        [1,2,2,2,2,2,2,2,2,2,2,2,2,2,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
    ];

    let player, ghosts, score, totalCoins, gameOver;

    function initializeGame() {
        player = { x: 7 * tileSize, y: 8 * tileSize, dx: 0, dy: 0, speed: 2, nextDx: 0, nextDy: 0 };
        ghosts = [
            { x: 6 * tileSize, y: 7 * tileSize, dx: 0, dy: 2, speed: 1.5, img: ghost1Img },
            { x: 8 * tileSize, y: 7 * tileSize, dx: 0, dy: -2, speed: 1.5, img: ghost2Img }
        ];
        score = 0;
        totalCoins = map.reduce((sum, row) => sum + row.filter(tile => tile === 2).length, 0);
        gameOver = false;
        document.getElementById('gameContainerPacman').style.display = 'block';
        document.getElementById('pacmanResult').style.display = 'none';
    }

    window.addEventListener('keydown', (e) => {
        e.preventDefault();
        switch(e.key) {
            case 'ArrowUp': case 'w': player.nextDx = 0; player.nextDy = -player.speed; break;
            case 'ArrowDown': case 's': player.nextDx = 0; player.nextDy = player.speed; break;
            case 'ArrowLeft': case 'a': player.nextDx = -player.speed; player.nextDy = 0; break;
            case 'ArrowRight': case 'd': player.nextDx = player.speed; player.nextDy = 0; break;
        }
    });

    function isWall(x, y) {
        const col = Math.floor(x / tileSize);
        const row = Math.floor(y / tileSize);
        if (row < 0 || row >= map.length || col < 0 || col >= map[0].length) {
            return true; // Anggap luar peta sebagai dinding
        }
        return map[row][col] === 1;
    }

    // Fungsi baru untuk memeriksa tabrakan dengan lebih akurat
    function canMove(x, y, dx, dy) {
        const nextX = x + dx;
        const nextY = y + dy;

        // Periksa keempat sudut dari posisi pemain berikutnya untuk memastikan tidak ada bagian yang menabrak
        if (isWall(nextX, nextY)) return false; // Kiri atas
        if (isWall(nextX + tileSize - 1, nextY)) return false; // Kanan atas
        if (isWall(nextX, nextY + tileSize - 1)) return false; // Kiri bawah
        if (isWall(nextX + tileSize - 1, nextY + tileSize - 1)) return false; // Kanan bawah

        return true;
    }

    function showResult(isWin) {
        gameOver = true;
        document.getElementById('gameContainerPacman').style.display = 'none';
        document.getElementById('pacmanResult').style.display = 'block';
        const title = document.getElementById('resultTitle');
        const message = document.getElementById('resultMessage');
        const nextButton = document.getElementById('nextButton');

        if (isWin) {
            title.textContent = "Kamu Menang!";
            message.textContent = `Hebat, semua koin terkumpul! Skor: ${score}`;
            nextButton.textContent = "Lanjut ke Game Ular";
            nextButton.onclick = () => { window.location.href = 'snake.html'; };
        } else {
            title.textContent = "Kamu Tertangkap!";
            message.textContent = "Jangan menyerah, coba lagi ya!";
            nextButton.textContent = "Main Lagi";
            nextButton.onclick = () => window.location.reload();
        }
    }

    function gameLoop() {
        if (gameOver) return;

        // --- Logika Pergerakan Pemain yang Diperbaiki ---
        const onGrid = (n) => n % tileSize === 0;

        // Cek jika bisa berbelok di persimpangan
        if (onGrid(player.x) && onGrid(player.y)) {
            if (player.nextDx !== 0 || player.nextDy !== 0) { // Jika ada input arah baru
                if (canMove(player.x, player.y, player.nextDx, player.nextDy)) {
                    player.dx = player.nextDx;
                    player.dy = player.nextDy;
                }
            }
        }

        // Cek jika akan menabrak dinding di arah saat ini
        if (!canMove(player.x, player.y, player.dx, player.dy)) {
            player.dx = 0;
            player.dy = 0;
        }

        player.x += player.dx;
        player.y += player.dy;


        // Terowongan
        if (player.x < -tileSize) player.x = canvas.width;
        if (player.x > canvas.width) player.x = -tileSize;

        // Cek Koin
        const playerCol = Math.floor((player.x + tileSize/2) / tileSize);
        const playerRow = Math.floor((player.y + tileSize/2) / tileSize);
        if (map[playerRow] && map[playerRow][playerCol] === 2) {
            map[playerRow][playerCol] = 0;
            score++;
            if (score === totalCoins) {
                showResult(true);
                return;
            }
        }

        // Gerakan & Cek Tabrakan Hantu
        ghosts.forEach(ghost => {
             // Gerakan hantu yang lebih simpel untuk mencegah bug
            if (Math.random() < 0.05) { // 5% chance to change direction
                const directions = [{dx: ghost.speed, dy: 0}, {dx: -ghost.speed, dy: 0}, {dx: 0, dy: ghost.speed}, {dx: 0, dy: -ghost.speed}];
                const newDir = directions[Math.floor(Math.random() * directions.length)];
                if (!isWall(ghost.x + newDir.dx, ghost.y + newDir.dy)) {
                    ghost.dx = newDir.dx;
                    ghost.dy = newDir.dy;
                }
            }
            if (isWall(ghost.x + ghost.dx, ghost.y + ghost.dy)) {
                ghost.dx = -ghost.dx;
                ghost.dy = -ghost.dy;
            }
            ghost.x += ghost.dx;
            ghost.y += ghost.dy;

            if (Math.hypot(player.x - ghost.x, player.y - ghost.y) < tileSize - 10) {
                showResult(false);
            }
        });

        // Gambar ulang semua elemen
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        for (let row = 0; row < map.length; row++) {
            for (let col = 0; col < map[row].length; col++) {
                if (map[row][col] === 1) {
                    ctx.fillStyle = '#1e90ff';
                    ctx.fillRect(col * tileSize, row * tileSize, tileSize, tileSize);
                } else if (map[row][col] === 2) {
                    ctx.fillStyle = '#ffd700';
                    ctx.beginPath();
                    ctx.arc(col * tileSize + tileSize / 2, row * tileSize + tileSize / 2, 5, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
        }
        ctx.drawImage(playerImg, player.x, player.y, tileSize, tileSize);
        ghosts.forEach(ghost => ctx.drawImage(ghost.img, ghost.x, ghost.y, tileSize, tileSize));

        requestAnimationFrame(gameLoop);
    }

    let imagesLoaded = 0;
    const totalImages = 3;
    [playerImg, ghost1Img, ghost2Img].forEach(img => {
        img.onload = () => {
            imagesLoaded++;
            if (imagesLoaded === totalImages) {
                initializeGame();
                gameLoop();
            }
        };
        img.onerror = () => {
             alert(`Gambar ${img.src.split('/').pop()} tidak ditemukan. Pastikan ada di folder frontend ya!`);
        };
    });

</script>

</body>
</html>